<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Travel Note</title>
    
    <!-- PWA è¨­å®š -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#F0A040">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">

    <!-- å„ªåŒ–ï¼šç§»é™¤åŒæ­¥è¼‰å…¥çš„ SheetJSï¼Œæ”¹ç‚ºå‹•æ…‹ Lazy Load -->

    <style>
        /* --- æ ¸å¿ƒ UI é¢¨æ ¼å®šç¾© (æ‰‹ç¹ªç­†è¨˜æœ¬é¢¨ - é‚„åŸç‰ˆ) --- */
        :root {
            --primary: #F0A040; --secondary: #90B44B; --money: #C64756;
            --flight-bg: #FFFFFF; --bg: #F9F7E8; --card-bg: #FFFFFF;
            --text: #3D3D3D; --gray: #A9A9A9; --border-color: #D3D3D3;
        }

        body {
            font-family: 'Avenir Next', 'Helvetica Neue', 'Helvetica', 'Arial', sans-serif;
            background-color: var(--bg); color: var(--text);
            margin: 0; padding: 0; height: 100vh;
            display: flex; flex-direction: column;
            padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom);
        }
        
        header {
            background-color: var(--card-bg); padding: 18px 25px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;
        }
        .header-title { font-size: 1.2rem; color: var(--primary); font-weight: 700; letter-spacing: 1px; }
        .header-controls { display: flex; gap: 15px; align-items: center; }
        
        .total-cost-display { font-size: 0.95rem; font-weight: 600; color: var(--money); border: none; background: transparent; }
        .action-btn { cursor: pointer; font-size: 0.9rem; color: var(--gray); display: flex; align-items: center; gap: 4px; font-weight: 500; transition: 0.2s; }
        .action-btn:hover { color: var(--secondary); }

        .main-wrapper { flex: 1; display: flex; flex-direction: column; overflow-y: auto; width: 100%; }

        .rate-bar {
            background: #FFFBEB; color: var(--text); padding: 10px; 
            font-size: 0.85rem; text-align: center; cursor: pointer; 
            border-bottom: 1px dashed var(--border-color); line-height: 1.4; flex-shrink: 0;
        }

        .day-tabs {
            display: flex; overflow-x: auto; padding: 15px 25px; gap: 10px;
            scrollbar-width: none; background: var(--bg); flex-shrink: 0;
        }
        .day-tab {
            padding: 8px 16px; background: #FFFFFF; border: 2px solid var(--border-color);
            border-radius: 20px; font-size: 0.85rem; font-weight: 600; color: var(--text);
            cursor: pointer; white-space: nowrap; box-shadow: 1px 1px 0 rgba(0,0,0,0.05); transition: 0.2s;
        }
        .day-tab.active { background-color: var(--primary); color: #fff; border-color: var(--primary); box-shadow: 2px 2px 0 rgba(0,0,0,0.1); }

        .summary-box {
            margin: 0 25px 15px 25px; background: var(--card-bg); padding: 20px; 
            border-radius: 12px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); border: 1px solid var(--border-color); flex-shrink: 0;
        }
        .summary-amount { font-size: 1.8rem; font-weight: 800; color: var(--money); }
        .summary-title { font-size: 0.85rem; color: var(--gray); cursor: pointer; text-decoration: underline dotted; }

        .timeline-container { padding: 10px 25px 80px 25px; max-width: 600px; margin: 0 auto; width: 100%; box-sizing: border-box; }
        .timeline-item { display: flex; margin-bottom: 30px; position: relative; animation: slideUp 0.3s ease-out; }
        .timeline-item::before {
            content: ''; position: absolute; left: 35px; top: 30px; bottom: -30px; width: 1px; 
            background-image: linear-gradient(to top, var(--border-color) 50%, rgba(255, 255, 255, 0) 50%);
            background-size: 1px 8px; z-index: 0;
        }
        .timeline-item:last-child::before { display: none; }

        .time-col { width: 70px; font-size: 0.9rem; color: var(--text); padding-top: 5px; text-align: left; padding-right: 15px; font-weight: 700; flex-shrink: 0; line-height: 1.3; }
        .time-col span { display: block; font-weight: normal; font-size: 0.75rem; color: var(--gray); margin-top: 2px; }

        .card {
            background: var(--card-bg); border-radius: 12px; padding: 18px; flex: 1;
            box-shadow: 4px 4px 0 var(--border-color), 0 2px 8px rgba(0,0,0,0.05); 
            position: relative; z-index: 1; border: 1px solid var(--border-color); transition: transform 0.1s;
        }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .card-title { font-weight: 700; font-size: 1.1rem; }
        .card-type-label { font-size: 0.75rem; font-weight: 700; padding: 4px 8px; border-radius: 6px; margin-bottom: 5px; display: inline-block; }
        .tag-spot { background: #E6F7FF; color: #1890FF; border: 1px solid #BAE7FF; } 
        .tag-food { background: #FFF7E6; color: #FAAD14; border: 1px solid #FFE7BA; } 
        .tag-transport { background: #F9E6FF; color: #9254DE; border: 1px solid #D3ADF7; } 
        .tag-shopping { background: #F6FFED; color: var(--secondary); border: 1px solid #D9F7BE; }
        .tag-flight { background: #EAEAEA; color: var(--text); border: 1px solid #CACACA; }

        .card-actions { display: flex; gap: 10px; }
        .btn-icon { cursor: pointer; color: var(--gray); font-size: 1.1rem; border: none; background: none; padding: 0; }
        .btn-icon:hover { color: var(--money); }
        .card-loc {
            font-size: 0.85rem; color: var(--primary); display: inline-flex; align-items: center; 
            gap: 4px; background: #F0F0F0; padding: 5px 10px; border-radius: 8px; 
            text-decoration: none; max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-top: 8px;
        }
        .flight-grid { display: grid; grid-template-columns: 20px 1fr; gap: 8px 10px; font-size: 0.9rem; align-items: center; margin-top: 8px; }
        .flight-icon { text-align: center; color: var(--gray); font-size: 0.9rem; }
        .flight-info-text { color: var(--text); }
        .flight-time-sub { font-size: 0.8rem; color: var(--gray); margin-left: 5px; }

        .transport-grid { display: grid; grid-template-columns: 20px 1fr; gap: 10px; margin-top: 8px; align-items: flex-start; }
        .transport-line { position: relative; display: flex; flex-direction: column; align-items: center; height: 100%; }
        .transport-dot { width: 8px; height: 8px; border-radius: 50%; border: 2px solid var(--border-color); background: #fff; z-index: 1;}
        .transport-bar { flex: 1; width: 2px; background: var(--border-color); margin: 2px 0; }
        
        .card-cost {
            margin-top: 10px; padding-top: 10px; border-top: 1px dashed var(--border-color);
            font-size: 1rem; color: var(--money); font-weight: 700;
            display: flex; justify-content: space-between; align-items: center;
        }

        .fab {
            position: fixed; bottom: 30px; right: 30px; width: 55px; height: 55px; 
            background: var(--primary); color: var(--card-bg); font-size: 30px; border: none; 
            cursor: pointer; z-index: 101; border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            display: flex; justify-content: center; align-items: center;
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); display: none; z-index: 200;
            justify-content: center; align-items: flex-end;
        }
        .modal-overlay.open { display: flex; }
        .modal {
            background: var(--bg); width: 100%; max-width: 500px;
            border-radius: 15px 15px 0 0; padding: 25px; animation: slideUpModal 0.3s; 
            display: flex; flex-direction: column; gap: 15px; max-height: 90vh; overflow-y: auto;
            border-top: 4px solid var(--secondary);
        }
        .form-label { display: block; margin-bottom: 5px; font-size: 0.9rem; color: var(--text); font-weight: 600; }
        .form-input, .zone-select, .currency-select {
            width: 100%; padding: 12px; border: 2px solid var(--border-color);
            border-radius: 8px; font-size: 1rem; background: var(--card-bg); color: var(--text); box-sizing: border-box; transition: 0.3s;
        }
        .form-row { display: flex; gap: 10px; }
        .input-panel {
            background: var(--flight-bg); padding: 15px; border-radius: 10px; 
            border: 1px dashed var(--border-color); display: none; flex-direction: column; gap: 15px;
        }
        .input-panel.show { display: flex; }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem; text-align: center;}
        .btn-primary { background: var(--primary); color: var(--card-bg); }
        .btn-cancel { background: var(--border-color); color: var(--text); }
        .btn-outline { background: transparent; border: 2px solid var(--primary); color: var(--primary); border-radius: 8px; font-weight:bold; cursor:pointer; padding: 8px;}

        #sys-toast {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; padding: 10px 20px; border-radius: 8px;
            font-size: 0.9rem; z-index: 10000; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        #sys-toast.show { opacity: 1; transform: translateX(-50%) translateY(10px); }
        #sys-confirm-overlay {
            position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: center; z-index: 9999;
        }
        .sys-box { background: #fff; padding: 20px; border-radius: 12px; text-align: center; width: 280px; }
        .sys-btns { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .sys-btn { padding: 8px 20px; border-radius: 6px; border:none; cursor:pointer; font-weight:bold; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUpModal { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* --- Responsive Desktop Design (>= 768px) --- */
        @media (min-width: 768px) {
            body { background-color: #EBE7D5; align-items: center; }
            header { width: 100%; max-width: 1000px; margin-bottom: 10px; border-radius: 0 0 12px 12px; }
            .main-wrapper {
                display: grid; grid-template-columns: 320px 1fr; gap: 25px;
                max-width: 1000px; width: 100%; padding: 0 20px 20px 20px;
                box-sizing: border-box; align-items: start; overflow-y: visible;
            }
            .dashboard-sidebar { display: flex; flex-direction: column; gap: 15px; position: sticky; top: 90px; }
            .rate-bar { border-radius: 10px; border: 1px solid var(--border-color); }
            .day-tabs { flex-wrap: wrap; justify-content: flex-start; padding: 0; background: transparent; }
            .day-tab { margin-bottom: 5px; flex: 0 0 auto; }
            .summary-box { margin: 0; }
            .timeline-container { max-width: none; padding: 0; margin: 0; overflow-y: visible; }
            .fab { right: calc((100vw - 1000px) / 2 + 40px); }
        }
        @media (min-width: 1080px) {
            .fab { right: 50%; margin-right: -460px; }
        }
    </style>
</head>
<body>

<header>
    <div class="header-title" id="headerTitle">TRAVEL NOTE</div>
    <div class="header-controls">
        <div class="total-cost-display" id="overallTotalCost">ç¸½è¨ˆ: TWD 0</div>
        <div class="action-btn" onclick="openSettingsModal()">ğŸ—“ï¸ è¨­å®š</div>
        <div class="action-btn" onclick="openPackingModal()">ğŸ’ æ¸…å–®</div>
        <div class="action-btn" onclick="openDataModal()">ğŸ“‚ è³‡æ–™</div>
        <div class="action-btn" onclick="clearData()">ğŸ—‘ï¸ é‡ç½®</div>
    </div>
</header>

<div class="main-wrapper">
    <div class="dashboard-sidebar">
        <div class="rate-bar" id="rateBar" onclick="openRateModal()">
            <div id="rateText">è¼‰å…¥åŒ¯ç‡ä¸­...</div>
        </div>
        <div class="summary-box">
            <div>
                <div style="font-size:0.8rem; color:var(--gray); margin-bottom:4px;">
                    Day <span id="currentDayNum">1</span> <span id="dateDisplayInSummary"></span>
                </div>
                <div class="summary-amount" id="dayTotal">TWD 0</div>
            </div>
        </div>
        <div class="day-tabs" id="dayTabs"></div>
    </div>
    <div class="timeline-container" id="timelineContainer"></div>
</div>

<button class="fab" onclick="openModal()">+</button>
<input type="file" id="importFile" accept=".xlsx, .xls" style="display: none;" onchange="importFromExcel(event)">

<div id="sys-toast">æç¤ºè¨Šæ¯</div>
<div id="sys-confirm-overlay">
    <div class="sys-box">
        <div id="sys-confirm-msg">ç¢ºèªåŸ·è¡Œï¼Ÿ</div>
        <div class="sys-btns">
            <button class="sys-btn" style="background:#eee" onclick="closeConfirm(false)">å–æ¶ˆ</button>
            <button class="sys-btn" style="background:var(--primary); color:#fff" onclick="closeConfirm(true)">ç¢ºå®š</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="itemModalOverlay">
    <div class="modal">
        <h2 style="margin:0; color:var(--primary);" id="modalTitle">æ–°å¢è¡Œç¨‹</h2>
        <div class="form-group">
            <label class="form-label">é¡å‹</label>
            <select class="form-input" id="inputType" onchange="toggleFields()">
                <option value="spot">ğŸ“· æ™¯é»</option>
                <option value="food">ğŸ´ ç¾é£Ÿ</option>
                <option value="transport">ğŸš† äº¤é€š</option>
                <option value="shopping">ğŸ›ï¸ è³¼ç‰©</option>
                <option value="flight">âœˆï¸ èˆªç­</option>
            </select>
        </div>
        <div id="normalFields">
            <div class="form-row">
                <div style="flex:1"><label class="form-label">æ™‚é–“</label><input type="time" class="form-input" id="inputTime"></div>
                <div style="flex:2"><label class="form-label">æ´»å‹•åç¨±</label><input type="text" class="form-input" id="inputTitle" placeholder="ä¾‹å¦‚: æ™´ç©ºå¡”"></div>
            </div>
            <div style="margin-top:15px;">
                <label class="form-label">åœ°é» / Map é€£çµ</label>
                <input type="text" class="form-input" id="inputLoc" placeholder="è²¼ä¸Š Google Maps é€£çµ">
            </div>
        </div>
        <div id="transportFields" class="input-panel">
            <label class="form-label">äº¤é€šæ–¹å¼</label>
            <input type="text" class="form-input" id="transportMode" placeholder="ä¾‹å¦‚: é«˜éµ, JR">
            <div class="form-row">
                <div style="flex:1"><label class="form-label">å‡ºç™¼æ™‚é–“</label><input type="time" class="form-input" id="transportDepTime"></div>
                <div style="flex:1"><label class="form-label">æŠµé”æ™‚é–“</label><input type="time" class="form-input" id="transportArrTime"></div>
            </div>
            <div style="margin-top:10px;">
                <input type="text" class="form-input" id="transportDepLoc" placeholder="å‡ºç™¼åœ° (ä¾‹å¦‚: æ±äº¬è»Šç«™)" style="margin-bottom:10px;">
                <input type="text" class="form-input" id="transportArrLoc" placeholder="ç›®çš„åœ° (ä¾‹å¦‚: å¤§é˜ªè»Šç«™)">
            </div>
        </div>
        <div id="flightFields" class="input-panel">
            <label class="form-label">èˆªç­ä»£è™Ÿ</label>
            <input type="text" class="form-input" id="flightCode" placeholder="ä¾‹å¦‚: JX800" style="text-transform:uppercase;">
            <div style="margin-top: 10px;">
                <label class="form-label" style="color:var(--primary);">ğŸ›« å‡ºç™¼ (ä»£è™Ÿ/æ™‚å€/æ™‚é–“)</label>
                <div class="form-row">
                    <input type="text" class="form-input" id="depCode" placeholder="TPE" style="flex:1; text-transform:uppercase" oninput="autoUpdateTimezone('depCode', 'depZone')">
                    <select id="depZone" class="zone-select" style="flex:1" onchange="calcDuration()"><option value="-12">UTC-12</option><option value="-11">UTC-11</option><option value="-10">UTC-10</option><option value="-9">UTC-9</option><option value="-8">UTC-8</option><option value="-7">UTC-7</option><option value="-6">UTC-6</option><option value="-5">UTC-5</option><option value="-4">UTC-4</option><option value="-3">UTC-3</option><option value="-2">UTC-2</option><option value="-1">UTC-1</option><option value="+0">UTC+0</option><option value="+1">UTC+1</option><option value="+2">UTC+2</option><option value="+3">UTC+3</option><option value="+4">UTC+4</option><option value="+5">UTC+5</option><option value="+6">UTC+6</option><option value="+7">UTC+7</option><option value="+8">UTC+8</option><option value="+9">UTC+9</option><option value="+10">UTC+10</option><option value="+11">UTC+11</option><option value="+12">UTC+12</option><option value="+13">UTC+13</option><option value="+14">UTC+14</option></select>
                </div>
                <input type="time" class="form-input" id="depTime" style="margin-top:5px;" onchange="calcDuration()">
            </div>
            <div style="margin-top: 10px;">
                <label class="form-label" style="color:var(--secondary);">ğŸ›¬ æŠµé” (ä»£è™Ÿ/æ™‚å€/æ™‚é–“)</label>
                <div class="form-row">
                    <input type="text" class="form-input" id="arrCode" placeholder="NRT" style="flex:1; text-transform:uppercase" oninput="autoUpdateTimezone('arrCode', 'arrZone')">
                    <select id="arrZone" class="zone-select" style="flex:1" onchange="calcDuration()"><option value="-12">UTC-12</option><option value="-11">UTC-11</option><option value="-10">UTC-10</option><option value="-9">UTC-9</option><option value="-8">UTC-8</option><option value="-7">UTC-7</option><option value="-6">UTC-6</option><option value="-5">UTC-5</option><option value="-4">UTC-4</option><option value="-3">UTC-3</option><option value="-2">UTC-2</option><option value="-1">UTC-1</option><option value="+0">UTC+0</option><option value="+1">UTC+1</option><option value="+2">UTC+2</option><option value="+3">UTC+3</option><option value="+4">UTC+4</option><option value="+5">UTC+5</option><option value="+6">UTC+6</option><option value="+7">UTC+7</option><option value="+8">UTC+8</option><option value="+9">UTC+9</option><option value="+10">UTC+10</option><option value="+11">UTC+11</option><option value="+12">UTC+12</option><option value="+13">UTC+13</option><option value="+14">UTC+14</option></select>
                </div>
                <input type="time" class="form-input" id="arrTime" style="margin-top:5px;" onchange="calcDuration()">
            </div>
            <div id="durationDisplay" style="text-align:center; font-size:0.9rem; color:var(--primary); font-weight:bold; margin-top:10px;"></div>
        </div>
        <div style="margin-top:15px;">
            <label class="form-label">é‡‘é¡</label>
            <div class="form-row">
                <select id="inputCurrency" class="currency-select" style="flex:1">
                    <option value="TWD">TWD</option><option value="JPY">JPY</option><option value="USD">USD</option>
                    <option value="EUR">EUR</option><option value="KRW">KRW</option><option value="THB">THB</option>
                    <option value="VND">VND</option><option value="PHP">PHP</option><option value="NZD">NZD</option>
                    <option value="GBP">GBP</option><option value="IDR">IDR</option><option value="CHF">CHF</option>
                </select>
                <input type="number" class="form-input" id="inputCost" placeholder="0" style="flex:2;">
            </div>
        </div>
        <div style="margin-top:15px;">
            <label class="form-label">å‚™è¨»</label>
            <textarea class="form-input" id="inputNotes" rows="2"></textarea>
        </div>
        <div class="btn-group">
            <button class="btn btn-cancel" onclick="closeModal('itemModalOverlay')">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="saveItem()">å„²å­˜</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="settingsModalOverlay"><div class="modal"><h2>æ—…ç¨‹è¨­å®š</h2><input type="text" class="form-input" id="inputTripName" placeholder="æ—…ç¨‹åç¨±"><input type="date" class="form-input" id="inputStartDate" style="margin-top:10px;"><div class="btn-group"><button class="btn btn-cancel" onclick="closeModal('settingsModalOverlay')">å–æ¶ˆ</button><button class="btn btn-primary" onclick="saveSettings()">å„²å­˜</button></div></div></div>

<div class="modal-overlay" id="rateModalOverlay">
    <div class="modal">
        <h2>åŒ¯ç‡è¨­å®š (æ‰‹å‹• / è‡ªå‹•)</h2>
        <div id="currentRatesList" style="background:#FAFAFA; padding:10px; border-radius:8px; border:1px dashed #CCC; font-size:0.9rem;"></div>
        <p style="font-size:0.85rem;color:#666;margin:10px 0;line-height:1.5;">
            ç³»çµ±æ¯ 10 åˆ†é˜è‡ªå‹•å¾ Global API æ›´æ–° (å«1.5%ç·©è¡)ã€‚<br>è‹¥ç„¡ç¶²è·¯ï¼Œè«‹åœ¨ä¸‹æ–¹<b>æ‰‹å‹•è¼¸å…¥</b>ã€‚
        </p>
        <div class="form-row" style="margin-top:10px;">
            <input type="text" id="currencyCode" class="form-input" placeholder="ä»£è™Ÿ (å¦‚ JPY)" style="text-transform:uppercase; flex:1;">
            <input type="number" id="exchangeRate" class="form-input" placeholder="åŒ¯ç‡ (1å¤–å¹£=?å°å¹£)" style="flex:2;">
        </div>
        <button class="btn-outline" style="width:100%; margin-top:10px;" onclick="fetchRateManual()">ğŸŒ å˜—è©¦ç·šä¸ŠæŠ“å– (è¼”åŠ©)</button>
        <div class="btn-group" style="margin-top:15px;">
            <button class="btn btn-cancel" onclick="closeModal('rateModalOverlay')">é—œé–‰</button>
            <button class="btn btn-primary" onclick="saveRate()">å„²å­˜è¨­å®š</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="packingModalOverlay"><div class="modal"><h2>ç‰©å“æ¸…å–®</h2><div class="form-row"><input type="text" id="newPackingItemName" class="form-input"><button class="btn btn-primary" onclick="addItemToPackingList()">æ–°å¢</button></div><div id="packingListContainer" style="margin-top:15px;"></div><button class="btn btn-cancel" onclick="closeModal('packingModalOverlay')">é—œé–‰</button></div></div>

<div class="modal-overlay" id="dataModalOverlay">
    <div class="modal">
        <h2 style="color:var(--primary)">è³‡æ–™å‚™ä»½ / é‚„åŸ</h2>
        <p style="font-size:0.9rem; color:#666; margin-bottom:15px; line-height: 1.5;">æ‚¨å¯ä»¥å°‡ç›®å‰çš„è¡Œç¨‹åŒ¯å‡ºæˆ Excel æª”æ¡ˆé€²è¡Œå‚™ä»½ï¼Œæˆ–æ˜¯åŒ¯å…¥ä¹‹å‰çš„å‚™ä»½æª”ã€‚</p>
        <div class="btn-group" style="flex-direction: column; gap: 15px;">
            <button class="btn btn-outline" onclick="exportToExcel(); closeModal('dataModalOverlay')">ğŸ“¥ åŒ¯å‡ºè¡Œç¨‹ (Excel)</button>
            <button class="btn btn-outline" onclick="triggerImport(); closeModal('dataModalOverlay')">ğŸ“‚ åŒ¯å…¥è¡Œç¨‹ (Excel)</button>
        </div>
        <button class="btn btn-cancel" style="margin-top:15px;" onclick="closeModal('dataModalOverlay')">é—œé–‰</button>
    </div>
</div>

<script>
    // --- å„ªåŒ–ï¼šå¸¸æ•¸æå– ---
    const AIRPORT_TIMEZONES = {
        "TPE": "+8", "TSA": "+8", "KHH": "+8", "RMQ": "+8",
        "NRT": "+9", "HND": "+9", "KIX": "+9", "FUK": "+9", "CTS": "+9", "OKA": "+9", "NGO": "+9", "SDJ": "+9", "ISG": "+9",
        "ICN": "+9", "GMP": "+9", "PUS": "+9", "CJU": "+9",
        "HKG": "+8", "MFM": "+8", "PEK": "+8", "PVG": "+8", "SHA": "+8", "CAN": "+8",
        "BKK": "+7", "DMK": "+7", "CNX": "+7", "SIN": "+8",
        "KUL": "+8", "BKI": "+8", "PEN": "+8", "SGN": "+7", "HAN": "+7", "DAD": "+7",
        "MNL": "+8", "CEB": "+8", "DPS": "+8", "CGK": "+7",
        "LAX": "-8", "SFO": "-8", "SEA": "-8", "LAS": "-8", "JFK": "-5", "EWR": "-5", "LGA": "-5",
        "ORD": "-6", "DFW": "-6", "HNL": "-10", "GUM": "+10",
        "LHR": "+0", "LGW": "+0", "CDG": "+1", "ORY": "+1", "FRA": "+1", "MUC": "+1", "BER": "+1",
        "FCO": "+1", "MXP": "+1", "AMS": "+1", "VIE": "+1", "PRG": "+1", "BCN": "+1", "MAD": "+1",
        "IST": "+3", "ZRH": "+1", "SYD": "+10", "MEL": "+10", "BNE": "+10", "AKL": "+12", "CHC": "+12", "DXB": "+4"
    };

    const DEFAULT_RATES = { 'JPY': 0.21, 'USD': 30.5, 'EUR': 32.5, 'TWD': 1.0 };
    const NEW_CURRENCIES = { 'THB': 0.9, 'VND': 0.0013, 'PHP': 0.56, 'NZD': 19.5, 'GBP': 40.5, 'IDR': 0.002, 'CHF': 35.5, 'KRW': 0.024 };

    // --- å„ªåŒ–ï¼šXSS é˜²è­·èˆ‡ Lazy Loading ---
    function escapeHtml(text) {
        if (!text) return "";
        return text.replace(/[&<>"']/g, function(m) {
            return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' }[m];
        });
    }

    function loadSheetJS() {
        if (window.XLSX) return Promise.resolve();
        showToast("â³ æ­£åœ¨è¼‰å…¥ Excel æ¨¡çµ„...");
        return new Promise((resolve, reject) => {
            const script = document.createElement('script');
            script.src = 'https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js';
            script.onload = () => { showToast("âœ… æ¨¡çµ„è¼‰å…¥å®Œæˆ"); resolve(); };
            script.onerror = () => { showToast("âŒ æ¨¡çµ„è¼‰å…¥å¤±æ•—"); reject(); };
            document.head.appendChild(script);
        });
    }

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(reg => console.log('SW Registered!', reg))
                .catch(err => console.log('SW Failed', err));
        });
    }

    let days = JSON.parse(localStorage.getItem('tripData_Edit')) || { 1: [] };
    let settings = JSON.parse(localStorage.getItem('tripSettings_Edit')) || { 
        rates: { ...DEFAULT_RATES }, 
        startDate: '',
        tripName: 'TRAVEL NOTE',
        packingList: [] 
    };

    for(const [k, v] of Object.entries(NEW_CURRENCIES)) {
        if (settings.rates[k] === undefined) settings.rates[k] = v;
    }

    let currentDay = 1;
    let editingItemId = null; 
    let lastUpdateStr = localStorage.getItem('lastRateUpdate_Edit') || 'å°šæœªæ›´æ–°'; 

    function showToast(msg) { const t=document.getElementById('sys-toast'); t.innerText=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
    let confirmCb = null;
    function openConfirm(msg, cb) { document.getElementById('sys-confirm-msg').innerText=msg; document.getElementById('sys-confirm-overlay').style.display='flex'; confirmCb=cb; }
    function closeConfirm(res) { document.getElementById('sys-confirm-overlay').style.display='none'; if(res&&confirmCb) confirmCb(); confirmCb=null; }

    async function fetchExchangeData() {
        try {
            const res = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
            if(!res.ok) throw new Error();
            const data = await res.json();
            return { source: 'Global API', rates: data.rates };
        } catch(e) { /* ignore */ }

        try {
            const res = await fetch('https://open.er-api.com/v6/latest/USD');
            if(!res.ok) throw new Error();
            const data = await res.json();
            return { source: 'Global (Backup)', rates: data.rates };
        } catch(e) { return null; }
    }

    async function autoUpdateRates(silent = false) {
        if(!settings.rates['TWD']) settings.rates['TWD'] = 1.0; 
        if(!silent) showToast("ğŸ”„ æ­£åœ¨æ›´æ–°åŒ¯ç‡...");
        
        const result = await fetchExchangeData();
        if(!result) { if(!silent) showToast("âš ï¸ é›¢ç·šæ¨¡å¼ï¼šç„¡æ³•æ›´æ–°åŒ¯ç‡"); return; }
        
        const { source, rates } = result; 
        const usdToTwd = rates['TWD']; 
        if(!usdToTwd) return;

        let updated = false;
        Object.keys(settings.rates).forEach(code => {
            if(code === 'TWD') return;
            const usdToTarget = rates[code]; 
            if(usdToTarget > 0) {
                const rate = (usdToTwd / usdToTarget) * 1.015; 
                settings.rates[code] = rate;
                updated = true;
            }
        });

        if(updated) {
            const now = new Date();
            lastUpdateStr = `${now.getHours().toString().padStart(2,'0')}:${now.getMinutes().toString().padStart(2,'0')}`;
            localStorage.setItem('tripSettings_Edit', JSON.stringify(settings));
            localStorage.setItem('lastRateUpdate_Edit', lastUpdateStr);
            renderRateBar();
            if(!silent) showToast(`âœ… æ›´æ–°æˆåŠŸ (${source})`);
        }
    }

    function initAutoUpdate() {
        if(navigator.onLine) { autoUpdateRates(true); }
        setInterval(() => { if(navigator.onLine) autoUpdateRates(true); }, 600000); 
    }

    async function fetchRateManual() {
        if(!navigator.onLine) { showToast("âŒ ç„¡ç¶²è·¯é€£ç·š"); return; }
        const code = document.getElementById('currencyCode').value.toUpperCase();
        if(code.length!==3) { alert("è«‹è¼¸å…¥3ç¢¼ä»£è™Ÿ"); return; }
        showToast("â³ æŠ“å–ä¸­...");
        
        const result = await fetchExchangeData();
        if(result) {
            const { rates } = result;
            const usdToTwd = rates['TWD'];
            const usdToTarget = rates[code];
            if(usdToTarget > 0 && usdToTwd > 0) {
                const rate = (usdToTwd / usdToTarget) * 1.015;
                document.getElementById('exchangeRate').value = rate.toFixed(4);
                showToast("âœ… æŠ“å–æˆåŠŸ");
            } else { showToast("âŒ ç„¡æ­¤è²¨å¹£è³‡æ–™"); }
        } else { showToast("âŒ é€£ç·šå¤±æ•—"); }
    }

    function triggerImport() { document.getElementById('importFile').click(); }

    async function importFromExcel(event) {
        const file = event.target.files[0];
        if (!file) return;

        // å„ªåŒ–ï¼šç­‰å¾…åº«è¼‰å…¥
        try { await loadSheetJS(); } catch(e) { return; }

        openConfirm("åŒ¯å…¥å°‡æœƒè¦†è“‹ç›®å‰çš„è¡Œç¨‹è³‡æ–™ï¼Œç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ", () => {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    const worksheet = workbook.Sheets["è¡Œç¨‹æ˜ç´°"];
                    if (worksheet) {
                        const jsonData = XLSX.utils.sheet_to_json(worksheet);
                        const newDays = {};
                        let foundStartDate = null;
                        
                        jsonData.forEach(row => {
                            const dayStr = row["Day"] || "Day 1";
                            const dayNum = parseInt(dayStr.replace("Day ", "")) || 1;
                            if (dayNum === 1 && row["æ—¥æœŸ"] && !foundStartDate) foundStartDate = row["æ—¥æœŸ"];
                            if (!newDays[dayNum]) newDays[dayNum] = [];

                            const typeMap = { 'æ™¯é»':'spot', 'ç¾é£Ÿ':'food', 'äº¤é€š':'transport', 'è³¼ç‰©':'shopping', 'èˆªç­':'flight' };
                            const type = typeMap[row["é¡å‹"]] || 'spot';

                            let time = row["æ™‚é–“"] || "", depTime = time, arrTime = "";
                            if (time.includes("-")) {
                                const parts = time.split("-").map(t => t.trim());
                                depTime = parts[0]; arrTime = parts[1];
                            }

                            const item = {
                                id: Date.now() + Math.random(),
                                type: type,
                                title: row["é …ç›®åç¨±"] || "",
                                cost: parseFloat(row["åŸå§‹é‡‘é¡"]) || 0,
                                currency: row["å¹£åˆ¥"] || "TWD",
                                notes: row["å‚™è¨»"] || ""
                            };

                            if (type === 'flight') {
                                item.depTime = depTime; item.arrTime = arrTime;
                                item.flightCode = item.title;
                                
                                let details = row["è©³ç´°è³‡è¨Š/åœ°é»"] || "";
                                item.depCode = ""; item.arrCode = ""; 
                                item.depZone = 8; item.arrZone = 8;

                                // --- BUG ä¿®å¾©ï¼šè§£æèˆªç­è©³ç´°è³‡è¨Š ---
                                if(details.includes("|") && details.includes("->")) {
                                    const parts = details.split("|")[1].split("->");
                                    if(parts.length >= 2) {
                                        item.depCode = parts[0].trim();
                                        item.arrCode = parts[1].trim();
                                        if(AIRPORT_TIMEZONES[item.depCode]) item.depZone = parseInt(AIRPORT_TIMEZONES[item.depCode]);
                                        if(AIRPORT_TIMEZONES[item.arrCode]) item.arrZone = parseInt(AIRPORT_TIMEZONES[item.arrCode]);
                                    }
                                }
                                if(item.depTime && item.arrTime) {
                                    item.duration = calculateDuration(item.depTime, item.arrTime, item.depZone, item.arrZone);
                                }
                                
                            } else if (type === 'transport') {
                                item.depTime = depTime; item.arrTime = arrTime;
                                item.transportMode = item.title;
                                
                                // --- BUG ä¿®å¾©ï¼šè§£æäº¤é€šèµ·è¨–é» ---
                                let details = row["è©³ç´°è³‡è¨Š/åœ°é»"] || "";
                                item.transportDepLoc = ""; item.transportArrLoc = "";
                                if(details.includes("|") && details.includes("->")) {
                                    const parts = details.split("|")[1].split("->");
                                    if(parts.length >= 2) {
                                        item.transportDepLoc = parts[0].trim();
                                        item.transportArrLoc = parts[1].trim();
                                    }
                                }

                            } else {
                                item.time = depTime; item.loc = row["è©³ç´°è³‡è¨Š/åœ°é»"] || "";
                            }
                            newDays[dayNum].push(item);
                        });

                        days = newDays;
                        if (foundStartDate && /^\d{4}-\d{2}-\d{2}$/.test(foundStartDate)) settings.startDate = foundStartDate;
                    }

                    const packSheet = workbook.Sheets["æ‰“åŒ…æ¸…å–®"];
                    if (packSheet) {
                        settings.packingList = XLSX.utils.sheet_to_json(packSheet).map(row => ({
                            n: row["ç‰©å“åç¨±"], chk: row["ç‹€æ…‹"] === "å·²å¸¶"
                        }));
                    }

                    // --- BUG ä¿®å¾©ï¼šä½¿ç”¨æª”åä½œç‚ºæ—…ç¨‹æ¨™é¡Œ ---
                    settings.tripName = file.name.replace(/\.[^/.]+$/, ""); 

                    saveData();
                    showToast("âœ… åŒ¯å…¥æˆåŠŸï¼");
                    setTimeout(() => location.reload(), 1000);
                } catch (error) { console.error(error); showToast("âŒ åŒ¯å…¥å¤±æ•—ï¼Œæ ¼å¼éŒ¯èª¤"); }
            };
            reader.readAsArrayBuffer(file);
        });
        event.target.value = '';
    }

    async function exportToExcel() {
        if (!confirm("ç¢ºå®šè¦åŒ¯å‡ºè¡Œç¨‹è¡¨ç‚º Excel å—ï¼Ÿ")) return;
        
        // å„ªåŒ–ï¼šç­‰å¾…åº«è¼‰å…¥
        try { await loadSheetJS(); } catch(e) { return; }

        const header = ["Day", "æ—¥æœŸ", "æ™‚é–“", "é¡å‹", "é …ç›®åç¨±", "è©³ç´°è³‡è¨Š/åœ°é»", "åŸå§‹é‡‘é¡", "å¹£åˆ¥", "åŒ¯ç‡", "å°å¹£(é ä¼°)", "å‚™è¨»"];
        const data = [header];
        const sortedDays = Object.keys(days).map(Number).sort((a,b)=>a-b);
        
        sortedDays.forEach(dayNum => {
            const items = days[dayNum];
            if (!items || items.length === 0) return;
            items.sort((a,b) => (a.time||a.depTime||'00:00').localeCompare(b.time||b.depTime||'00:00'));

            let dateStr = "";
            if (settings.startDate) {
                const d = new Date(settings.startDate);
                d.setDate(d.getDate() + (dayNum - 1));
                const y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), dd = String(d.getDate()).padStart(2, '0');
                dateStr = `${y}-${m}-${dd}`;
            }

            items.forEach(item => {
                let details = "", timeStr = item.time || "";
                if (item.type === 'flight') {
                    timeStr = `${item.depTime} - ${item.arrTime}`;
                    details = `èˆªç­: ${item.flightCode || '-'} | ${item.depCode} -> ${item.arrCode}`;
                } else if (item.type === 'transport') {
                    timeStr = `${item.depTime} - ${item.arrTime}`;
                    details = `${item.transportMode || 'äº¤é€š'} | ${item.transportDepLoc} -> ${item.transportArrLoc}`;
                } else { details = item.loc || ""; }

                const currency = item.currency || 'TWD', rate = settings.rates[currency] || 1;
                const cost = item.cost || 0, costTWD = Math.round(cost * rate);
                const typeNameMap = { 'spot':'æ™¯é»', 'food':'ç¾é£Ÿ', 'transport':'äº¤é€š', 'shopping':'è³¼ç‰©', 'flight':'èˆªç­' };

                data.push([
                    `Day ${dayNum}`, dateStr, timeStr, typeNameMap[item.type] || item.type,
                    item.title || item.flightCode || item.transportMode || '',
                    details, cost > 0 ? cost : '', cost > 0 ? currency : '',
                    cost > 0 && currency !== 'TWD' ? rate.toFixed(3) : '',
                    cost > 0 ? costTWD : '', item.notes || ''
                ]);
            });
        });

        const ws = XLSX.utils.aoa_to_sheet(data);
        ws['!cols'] = [{ wch: 6 }, { wch: 12 }, { wch: 12 }, { wch: 6 }, { wch: 20 }, { wch: 30 }, { wch: 10 }, { wch: 6 }, { wch: 8 }, { wch: 10 }, { wch: 30 }];
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "è¡Œç¨‹æ˜ç´°");

        if (settings.packingList && settings.packingList.length > 0) {
            const packData = [["ç‹€æ…‹", "ç‰©å“åç¨±"]];
            settings.packingList.forEach(p => packData.push([p.chk ? "å·²å¸¶" : "æœªå¸¶", p.n]));
            const wsPack = XLSX.utils.aoa_to_sheet(packData);
            XLSX.utils.book_append_sheet(wb, wsPack, "æ‰“åŒ…æ¸…å–®");
        }

        XLSX.writeFile(wb, `${settings.tripName || 'Travel_Note'}.xlsx`);
    }

    function renderUI() {
        document.getElementById('headerTitle').textContent = (settings.tripName || 'TRAVEL NOTE');
        document.getElementById('overallTotalCost').textContent = `ç¸½è¨ˆ: TWD ${calcTotal()}`;
        renderRateBar();
        renderTabs();
        renderTimeline();
    }

    function renderRateBar() {
        const targetCurrencies = ['JPY', 'USD'];
        const rateList = [];
        targetCurrencies.forEach(code => {
            if(settings.rates[code]) rateList.push(`1${code}â‰ˆ${settings.rates[code].toFixed(2)}`);
        });
        const rateStr = rateList.length ? rateList.join(' | ') : 'è¼‰å…¥åŒ¯ç‡ä¸­...';
        document.getElementById('rateText').innerHTML = `<div style="font-weight:700">${rateStr}</div><div style="font-size:0.75rem; color:#666; margin-top:3px;">ä¾†æº: Global API (å«1.5%ç·©è¡) | æ›´æ–°: ${lastUpdateStr}</div>`;
    }

    // --- å„ªåŒ–ï¼šä½¿ç”¨ DocumentFragment ---
    function renderTimeline() {
        const container = document.getElementById('timelineContainer');
        container.innerHTML = '';
        document.getElementById('currentDayNum').textContent = currentDay;
        
        if (settings.startDate) {
            const d = new Date(settings.startDate);
            d.setDate(d.getDate() + currentDay - 1);
            document.getElementById('dateDisplayInSummary').textContent = `(${d.getMonth()+1}/${d.getDate()})`;
        } else {
            document.getElementById('dateDisplayInSummary').textContent = '';
        }

        const items = days[currentDay] || [];
        let dayTotal = 0;
        items.forEach(i => dayTotal += (i.cost||0) * (settings.rates[i.currency||'TWD']||1));
        document.getElementById('dayTotal').textContent = `TWD ${Math.round(dayTotal).toLocaleString()}`;

        items.sort((a,b) => (a.time||a.depTime||'00:00').localeCompare(b.time||b.depTime||'00:00'));

        if(items.length===0) { container.innerHTML='<div style="text-align:center;color:#ccc;margin-top:50px;">é»æ“Š + æ–°å¢è¡Œç¨‹</div>'; return; }

        const fragment = document.createDocumentFragment();
        items.forEach(item => {
            const div = document.createElement('div');
            div.className = 'timeline-item';
            div.innerHTML = getCardHTML(item);
            fragment.appendChild(div);
        });
        container.appendChild(fragment);
    }

    // --- å„ªåŒ–ï¼šåŠ å…¥ escapeHtml é˜²è­· ---
    function getCardHTML(item) {
        let timeDisplay = item.time || item.depTime || '';
        let timeSub = '';
        if(item.type === 'flight') timeSub = 'èµ·é£›';
        if(item.type === 'transport') timeSub = 'å‡ºç™¼';
        const timeCol = timeDisplay ? `${escapeHtml(timeDisplay)}<span>${timeSub}</span>` : 'å…¨æ—¥';

        let costHTML = '';
        if (item.cost > 0) {
            const rate = settings.rates[item.currency||'TWD'] || 1;
            const twd = Math.round(item.cost * rate).toLocaleString();
            costHTML = `<div class="card-cost"><span>${escapeHtml(item.currency)} ${item.cost.toLocaleString()}</span><span style="font-size:0.8em;color:#999;">â‰ˆ TWD ${twd}</span></div>`;
        }

        const tagMap = { 'spot':'tag-spot', 'food':'tag-food', 'transport':'tag-transport', 'shopping':'tag-shopping', 'flight':'tag-flight' };
        const tagName = { 'spot':'æ™¯é»', 'food':'ç¾é£Ÿ', 'transport':'äº¤é€š', 'shopping':'è³¼ç‰©', 'flight':'èˆªç­' };
        const tagHTML = `<span class="card-type-label ${tagMap[item.type]||''}">${tagName[item.type]||'æ´»å‹•'}</span>`;

        let contentHTML = '';
        let title = item.title; 

        if (item.type === 'flight') {
            title = item.title || item.flightCode || 'èˆªç­è¡Œç¨‹';
            contentHTML += `
                <div class="flight-grid">
                    <div class="flight-icon">âœˆï¸</div><div class="flight-info-text" style="font-weight:bold;">${escapeHtml(item.flightCode || 'èˆªç­')}</div>
                    <div class="flight-icon">ğŸ›«</div><div class="flight-info-text">${escapeHtml(item.depTime)} <span class="flight-time-sub">${escapeHtml(item.depCode)} (UTC${item.depZone})</span></div>
                    <div class="flight-icon">ğŸ›¬</div><div class="flight-info-text">${escapeHtml(item.arrTime)} <span class="flight-time-sub">${escapeHtml(item.arrCode)} (UTC${item.arrZone})</span></div>
                </div>`;
        } else if (item.type === 'transport') {
            title = item.title || item.transportMode || 'äº¤é€šè¡Œç¨‹';
            contentHTML += `
                <div class="transport-grid">
                    <div class="transport-line"><div class="transport-dot"></div><div class="transport-bar"></div><div class="transport-dot" style="background:var(--border-color);"></div></div>
                    <div>
                        <div style="font-weight:bold; color:var(--text);">${escapeHtml(item.transportMode || 'äº¤é€š')}</div>
                        <div class="transport-detail" style="margin-top:4px; font-size:0.9rem;">${escapeHtml(item.depTime)} ${escapeHtml(item.transportDepLoc||'èµ·é»')}</div>
                        <div class="transport-detail" style="font-size:0.9rem;">${escapeHtml(item.arrTime)} ${escapeHtml(item.transportArrLoc||'çµ‚é»')}</div>
                    </div>
                </div>`;
        } else {
            if(item.loc) {
                const isUrl = item.loc.startsWith('http');
                const url = isUrl ? item.loc : `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.loc)}`;
                const locText = item.loc.length > 30 ? 'åœ°åœ–é€£çµ' : item.loc;
                contentHTML += `<a href="${escapeHtml(url)}" target="_blank" class="card-loc">ğŸ“ ${escapeHtml(locText)}</a>`;
            }
        }
        
        if(item.notes) {
            contentHTML += `<div style="font-size:0.85rem; color:#666; margin-top:8px; white-space: pre-wrap; padding-top:4px; border-top:1px dashed #eee;">${escapeHtml(item.notes)}</div>`;
        }

        return `
            <div class="time-col">${timeCol}</div>
            <div class="card type-${item.type}">
                <div class="card-header">
                    <div class="card-title-group">
                        ${tagHTML}
                        <div class="card-title">${escapeHtml(title)}</div>
                        ${item.type==='flight' && item.duration ? `<span style="font-size:0.75rem; color:var(--secondary);">â³ ${escapeHtml(item.duration)}</span>` : ''}
                    </div>
                    <div class="card-actions"><button class="btn-icon" onclick="openModal(${item.id})">âœ</button><button class="btn-icon" onclick="deleteItem(${item.id})">Ã—</button></div>
                </div>
                ${contentHTML} ${costHTML}
            </div>`;
    }

    function saveItem() {
        const type = document.getElementById('inputType').value;
        const cost = parseFloat(document.getElementById('inputCost').value) || 0;
        const currency = document.getElementById('inputCurrency').value;
        const notes = document.getElementById('inputNotes').value.trim();
        const inputTime = document.getElementById('inputTime').value;
        
        let newItem = { id: editingItemId || Date.now(), type, cost, currency, notes };

        if (type === 'flight') {
            newItem.flightCode = document.getElementById('flightCode').value.toUpperCase().trim();
            newItem.depCode = document.getElementById('depCode').value.toUpperCase().trim();
            newItem.arrCode = document.getElementById('arrCode').value.toUpperCase().trim();
            newItem.depTime = document.getElementById('depTime').value;
            newItem.arrTime = document.getElementById('arrTime').value;
            newItem.depZone = parseInt(document.getElementById('depZone').value);
            newItem.arrZone = parseInt(document.getElementById('arrZone').value);
            newItem.title = newItem.flightCode || `èˆªç­ ${newItem.depCode}â${newItem.arrCode}`;
            newItem.time = newItem.depTime;
            newItem.duration = calculateDuration(newItem.depTime, newItem.arrTime, newItem.depZone, newItem.arrZone);
        } else if (type === 'transport') {
            newItem.transportMode = document.getElementById('transportMode').value.trim();
            newItem.depTime = document.getElementById('transportDepTime').value;
            newItem.arrTime = document.getElementById('transportArrTime').value;
            newItem.transportDepLoc = document.getElementById('transportDepLoc').value.trim();
            newItem.transportArrLoc = document.getElementById('transportArrLoc').value.trim();
            newItem.title = newItem.transportMode || 'äº¤é€š';
            newItem.time = newItem.depTime;
        } else {
            const title = document.getElementById('inputTitle').value.trim() || 'æœªå‘½å'; 
            const loc = document.getElementById('inputLoc').value.trim();
            newItem.title = title; newItem.time = inputTime; newItem.loc = loc;
        }

        if(editingItemId) {
            const idx = days[currentDay].findIndex(i=>i.id===editingItemId);
            if(idx!==-1) days[currentDay][idx] = newItem;
        } else { days[currentDay].push(newItem); }
        
        saveData(); closeModal('itemModalOverlay'); renderUI();
    }

    function openModal(id) {
        editingItemId = id; document.getElementById('itemModalOverlay').classList.add('open');
        document.querySelectorAll('.form-input').forEach(e => e.value = '');
        document.getElementById('inputTime').value = '09:00';
        document.getElementById('inputType').value = 'spot';
        document.getElementById('inputCurrency').value = 'TWD';
        document.getElementById('depZone').value = 8; document.getElementById('arrZone').value = 9;
        document.getElementById('durationDisplay').textContent = '';

        if(id) {
            const item = days[currentDay].find(i=>i.id===id);
            if(item) {
                document.getElementById('inputType').value = item.type;
                document.getElementById('inputCurrency').value = item.currency || 'TWD';
                document.getElementById('inputCost').value = item.cost || '';
                document.getElementById('inputNotes').value = item.notes || '';
                
                if (item.type === 'flight') {
                    document.getElementById('flightCode').value = item.flightCode || '';
                    document.getElementById('depCode').value = item.depCode || '';
                    document.getElementById('arrCode').value = item.arrCode || '';
                    document.getElementById('depTime').value = item.depTime || '09:00';
                    document.getElementById('arrTime').value = item.arrTime || '10:00';
                    
                    // --- BUG ä¿®å¾©ï¼šæ ¼å¼åŒ–æ™‚å€ä»¥ç¬¦åˆ select option çš„å­—ä¸²æ ¼å¼ (+8) ---
                    const formatZone = z => (parseInt(z) >= 0 ? '+' : '') + parseInt(z);
                    document.getElementById('depZone').value = formatZone(item.depZone !== undefined ? item.depZone : 8);
                    document.getElementById('arrZone').value = formatZone(item.arrZone !== undefined ? item.arrZone : 9);
                    
                    calcDuration();
                } else if (item.type === 'transport') {
                    document.getElementById('transportMode').value = item.transportMode || '';
                    document.getElementById('transportDepTime').value = item.depTime || '09:00';
                    document.getElementById('transportArrTime').value = item.arrTime || '10:00';
                    document.getElementById('transportDepLoc').value = item.transportDepLoc || '';
                    document.getElementById('transportArrLoc').value = item.transportArrLoc || '';
                } else {
                    document.getElementById('inputTitle').value = item.title || '';
                    document.getElementById('inputTime').value = item.time || '09:00';
                    document.getElementById('inputLoc').value = item.loc || '';
                }
            }
        }
        toggleFields();
    }
    
    function closeModal(id) { document.getElementById(id).classList.remove('open'); editingItemId=null; }
    function deleteItem(id) { openConfirm('åˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿ', ()=>{ days[currentDay]=days[currentDay].filter(i=>i.id!==id); saveData(); renderUI(); }); }
    function calcTotal() { let t=0; Object.values(days).flat().forEach(i=>t+=(i.cost||0)*(settings.rates[i.currency]||1)); return Math.round(t).toLocaleString(); }
    
    function toggleFields() {
        const t = document.getElementById('inputType').value;
        const isFlight = t==='flight', isTrans = t==='transport';
        document.getElementById('normalFields').style.display = (isFlight||isTrans)?'none':'block';
        document.getElementById('flightFields').className = isFlight?'input-panel show':'input-panel';
        document.getElementById('transportFields').className = isTrans?'input-panel show':'input-panel';
    }

    function calcDuration() {
        const dT=document.getElementById('depTime').value, aT=document.getElementById('arrTime').value;
        const dZ=parseInt(document.getElementById('depZone').value), aZ=parseInt(document.getElementById('arrZone').value);
        if(!dT || !aT) return;
        document.getElementById('durationDisplay').textContent = `é ä¼°é£›è¡Œ: ${calculateDuration(dT,aT,dZ,aZ)}`;
    }

    function calculateDuration(depStr, arrStr, depZ, arrZ) {
        let [dh, dm] = depStr.split(':').map(Number);
        let [ah, am] = arrStr.split(':').map(Number);
        let depMins = dh*60 + dm - (depZ*60);
        let arrMins = ah*60 + am - (arrZ*60);
        if (arrMins < depMins) arrMins += 24*60; 
        let diff = arrMins - depMins;
        return `${Math.floor(diff/60)}h ${diff%60}m`;
    }

    function autoUpdateTimezone(codeId, zoneId) {
        const c = document.getElementById(codeId).value.toUpperCase();
        if(AIRPORT_TIMEZONES[c] !== undefined) { document.getElementById(zoneId).value = AIRPORT_TIMEZONES[c]; calcDuration(); }
    }
    
    function saveData() { localStorage.setItem('tripData_Edit', JSON.stringify(days)); localStorage.setItem('tripSettings_Edit', JSON.stringify(settings)); }
    function clearData() { openConfirm('æ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼Ÿ', ()=>{ localStorage.clear(); location.reload(); }); }
    
    function renderTabs() {
        const c = document.getElementById('dayTabs'); c.innerHTML='';
        const keys = Object.keys(days).map(Number).sort((a,b)=>a-b);
        const max = keys.length?Math.max(...keys):1;
        const frag = document.createDocumentFragment();
        for(let i=1;i<=max;i++) {
            const d=document.createElement('div'); d.className=`day-tab ${i===currentDay?'active':''}`; d.textContent=`Day ${i}`;
            d.onclick=()=>{currentDay=i;renderUI();}; frag.appendChild(d);
        }
        const add=document.createElement('div'); add.className='day-tab'; add.textContent='+';
        add.onclick=()=>{days[max+1]=[]; saveData(); currentDay=max+1; renderUI();}; frag.appendChild(add);
        c.appendChild(frag);
    }

    function openSettingsModal() { document.getElementById('settingsModalOverlay').classList.add('open'); document.getElementById('inputTripName').value=settings.tripName; document.getElementById('inputStartDate').value=settings.startDate; }
    function saveSettings() { settings.tripName=document.getElementById('inputTripName').value; settings.startDate=document.getElementById('inputStartDate').value; saveData(); closeModal('settingsModalOverlay'); renderUI(); }
    function openRateModal() { document.getElementById('rateModalOverlay').classList.add('open'); renderRateBarList(); }
    function renderRateBarList() {
        const c=document.getElementById('currentRatesList'); 
        const html = Object.keys(settings.rates).map(k=>`<div><b>${k}</b>: ${settings.rates[k].toFixed(4)}</div>`).join('');
        c.innerHTML = html || 'ç„¡è¨­å®š';
    }
    function saveRate() { settings.rates[document.getElementById('currencyCode').value.toUpperCase()] = parseFloat(document.getElementById('exchangeRate').value); saveData(); closeModal('rateModalOverlay'); renderUI(); }
    function openPackingModal() { document.getElementById('packingModalOverlay').classList.add('open'); renderPacking(); }
    function renderPacking() { 
        const c=document.getElementById('packingListContainer'); c.innerHTML=''; 
        const frag = document.createDocumentFragment();
        settings.packingList.forEach((item,idx)=>{
            const d=document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px dashed #ddd';
            d.innerHTML=`<input type="checkbox" ${item.chk?'checked':''} onchange="togglePack(${idx})"> ${escapeHtml(item.n)} <button onclick="delPack(${idx})" style="float:right;border:none;background:none;color:red;">Ã—</button>`;
            frag.appendChild(d);
        });
        c.appendChild(frag);
    }
    function addItemToPackingList() { 
        const val = document.getElementById('newPackingItemName').value.trim();
        if(val) { settings.packingList.push({n:val, chk:false}); document.getElementById('newPackingItemName').value=''; saveData(); renderPacking(); }
    }
    function togglePack(idx) { settings.packingList[idx].chk=!settings.packingList[idx].chk; saveData(); }
    function delPack(idx) { settings.packingList.splice(idx,1); saveData(); renderPacking(); }
    function openDataModal() { document.getElementById('dataModalOverlay').classList.add('open'); }

    document.addEventListener('DOMContentLoaded', () => {
        renderUI();
        initAutoUpdate(); 
    });
</script>
</body>
</html>